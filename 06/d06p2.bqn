#! /usr/bin/env -S bqn -f

Load â† >âˆ˜â€¢FLines
Solve â† { ğ•Š map:
  ni â† Ã—Â´ âŸ¨nr, ncâŸ© â† â‰¢map
  igrid â† nrâ€¿nc â¥Š â†•ni
  i0 â† âŠ‘ â¥ŠâŠ¸âŠâŸœ'^' map
  rots â† âŸ¨â‰, âŒ½Ë˜, âŒ½Ë˜âˆ˜â‰, âŠ¢âŸ©
  obs â† '#'=map

  MkDestLine â† 0âŠ¸â‰ â—¶âŠ£â€¿âŠ¢` Â¯1âŠ¸Â»âŠ¸Ã—
  Path â† {
    ğ•© < 0 ? ğ•¨ğ•Š|ğ•© ; ğ•© < ğ•¨ ? ğ•©ğ•Šğ•¨ ;
    nc â‰¤ ğ•©-ğ•¨ ? ğ•¨ + nc Ã— 0ğ•Š(nc âŒŠâˆ˜Ã·Ëœ ğ•©-ğ•¨) ;
    ğ•¨ + â†•ğ•©Â¬ğ•¨
  }

  VisitAll â† { ğ•Š obs:
    dests â† {â¥Š obs MkDestLineË˜âŒ¾ğ• igrid}Â¨ rots
    visited â† >4/â‹ˆniâ¥Š0
    Travel â† { âŸ¨i, d, Â·âŸ©:
      âŸ¨iâ†©iâŠ‘dâŠ‘dests, dâ†©4|1+d, ((dÃ—ni)+(i))âŠ‘â¥ŠvisitedâŸ©
    }

    Step â† { âŸ¨i, d, Â·âŸ©:
      âŸ¨i1, Â·, Â·âŸ© â† x1 â† Travel ğ•©
      visited â†© (1â‰0)âŒ¾(((dÃ—ni)+(i Path i1))âŠ¸âŠâˆ˜â¥Š) visited
      x1
    }
    NotDone â† { âŸ¨i, Â·, vâŸ©: (i>0) âˆ§ (Â¬v) }
    âŸ¨Â·, Â·, vâŸ© â† Step â€¢_while_ NotDone i0â€¿0â€¿0

    v â‹ˆ visited
  }

  options â† (â¥Šigrid) /Ëœ (0â‰0)âŒ¾(i0âŠ¸âŠ) âˆ¨Ë 1 âŠ‘ VisitAll obs
  result â† +Â´ {âŠ‘ VisitAll (1â‰0)âŒ¾(ğ•©âŠ¸âŠâˆ˜â¥Š) obs}Â¨ options
  result
}

â€¢Showâˆ˜Solveâˆ˜LoadÂ¨ â€¢args
