#! /usr/bin/env -S bqn -f

SplitM â† (Â¬-Ëœ âŠ¢Ã— Â·+`Â»âŠ¸>)âŠ¸âŠ”

Load â† {{aâ€¿b: (>a)â€¿(âˆ¾b)} ""âŠ¸â‰¢Â¨âŠ¸SplitM â€¢FLines ð•©}
moveopts â† "^>v<"
deltas â† âŸ¨Â¯1â€¿0, 0â€¿1, 1â€¿0, 0â€¿Â¯1âŸ©
Solve â† { ð•Š mapâ€¿moves:
  rpos0 â† âŠ‘ ('@'=map) /â—‹â¥Š â†•â‰¢map
  map '.'âŒ¾(rpos0âŠ¸âŠ‘)â†©
  moves (âŠâŸœdeltas moveoptsâŠ¸âŠ)â†©

  NextEmpty â† { ð•Š p0â€¿d:
    p â† p0 + d
    CheckSquare â† {
      ð•Š '.': 0 ;
      ð•Š '#': p â†© p0 â‹„ 0 ;
      ð•Š 'O': p +â†© d â‹„ 1 ;
      ! "Unexpected map entry"
    }
    Step â† {ð•¤â‹„ CheckSquare pâŠ‘map }
    (Step)â€¢_while_(âŠ¢) 1
    p
  }
  TryMove â† { d ð•Š rpos:
    rpos1 â† d+rpos â‹„ epos â† NextEmpty rposâ€¿d â‹„ {
      epos â‰¡ rpos ? rpos ;
      epos â‰¡ rpos1 ? rpos1 ;
      map '.'âŒ¾(rpos1âŠ¸âŠ‘)â†©
      Step â† { ð•Š p: p+â†©d â‹„ map 'O'âŒ¾(pâŠ¸âŠ‘)â†© â‹„ p }
      (Step)â€¢_while_(eposâŠ¸â‰¢) rpos1
      rpos1
    }
  }
  rpos0 TryMoveÂ´ âŒ½moves

  +Â´ 100â€¿1Ã— +Ë > ('O'=map) /â—‹â¥Š â†•â‰¢map
}

â€¢Showâˆ˜Solveâˆ˜LoadÂ¨ â€¢args
